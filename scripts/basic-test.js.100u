import http from 'k6/http';
import { check, sleep } from 'k6';
import { Counter, Rate, Trend } from 'k6/metrics';

// è‡ªå®šç¾©æŒ‡æ¨™ - æº«å’Œå‹å£“åŠ›æ¸¬è©¦ï¼ˆ20/40/100 ç”¨æˆ¶ï¼‰ï¼Œå°ˆç‚º Grafana ç›£æ§è¨­è¨ˆ
let moderateLoadErrors = new Rate('moderate_load_errors');
let moderateLoadResponseTime = new Trend('moderate_load_response_time');
let moderateLoadRequests = new Counter('moderate_load_requests');
let responseTimeP95 = new Trend('response_time_p95');
let responseTimeP99 = new Trend('response_time_p99');
let successfulRequests = new Counter('successful_requests');
let failedRequests = new Counter('failed_requests');
let loadStageMetric = new Counter('load_stage_metric');

// æ¸¬è©¦é…ç½® - ä¾æ“šåœ–ç‰‡èªªæ˜çš„ç²¾ç¢ºæ¸¬è©¦æƒ…å¢ƒ
export const options = {
  // ä½¿ç”¨ scenarios é…ç½® - åˆ†éšæ®µæ¸¬è©¦ï¼ˆ20/40/100 ç”¨æˆ¶ï¼‰
  scenarios: {
    // ç¬¬ä¸€éšæ®µï¼š20 ç”¨æˆ¶æ¸¬è©¦
    // æ¯éš”30ç§’æ–°å¢10ä½ä½¿ç”¨è€…ï¼Œç›´åˆ°20ä½ä½¿ç”¨è€…
    stage_20_users: {
      executor: 'ramping-vus',
      stages: [
        // åŠ å£“æœŸé–“ï¼šæ¯éš”30ç§’æ–°å¢10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 10 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ10ä½ä½¿ç”¨è€…
        { duration: '25s', target: 10 },  // ç¶­æŒ10ä½ä½¿ç”¨è€…25ç§’ï¼ˆå…±30ç§’ï¼‰
        { duration: '5s', target: 20 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ20ä½ä½¿ç”¨è€…
        { duration: '25s', target: 20 },  // ç¶­æŒ20ä½ä½¿ç”¨è€…25ç§’ï¼ˆå…±30ç§’ï¼‰
        
        // é«˜å³°æœŸé–“ï¼šç¶­æŒå£“åŠ›60ç§’
        { duration: '60s', target: 20 },  // ç¶­æŒ20ä½ä½¿ç”¨è€…60ç§’
        
        // é™å£“æœŸé–“ï¼šæ¯5ç§’ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 10 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 0 },    // 5ç§’å…§ç§»é™¤å‰©é¤˜10ä½ä½¿ç”¨è€…
      ],
      gracefulRampDown: '5s',
      gracefulStop: '5s',
      tags: {
        test_type: 'stage_20_users',
        target: 'production',
        max_users: '20'
      }
    },
    
    // ç¬¬äºŒéšæ®µï¼š40 ç”¨æˆ¶æ¸¬è©¦ï¼ˆåœ¨ç¬¬ä¸€éšæ®µå®Œæˆå¾Œé–‹å§‹ï¼‰
    // æ¯éš”30ç§’æ–°å¢10ä½ä½¿ç”¨è€…ï¼Œç›´åˆ°40ä½ä½¿ç”¨è€…
    stage_40_users: {
      executor: 'ramping-vus',
      startTime: '130s',  // ç¬¬ä¸€éšæ®µå®Œæˆå¾Œé–‹å§‹
      stages: [
        // åŠ å£“æœŸé–“ï¼šæ¯éš”30ç§’æ–°å¢10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 10 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ10ä½ä½¿ç”¨è€…
        { duration: '25s', target: 10 },  // ç¶­æŒ10ä½ä½¿ç”¨è€…25ç§’ï¼ˆå…±30ç§’ï¼‰
        { duration: '5s', target: 20 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ20ä½ä½¿ç”¨è€…
        { duration: '25s', target: 20 },  // ç¶­æŒ20ä½ä½¿ç”¨è€…25ç§’ï¼ˆå…±30ç§’ï¼‰
        { duration: '5s', target: 30 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ30ä½ä½¿ç”¨è€…
        { duration: '25s', target: 30 },  // ç¶­æŒ30ä½ä½¿ç”¨è€…25ç§’ï¼ˆå…±30ç§’ï¼‰
        { duration: '5s', target: 40 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ40ä½ä½¿ç”¨è€…
        { duration: '25s', target: 40 },  // ç¶­æŒ40ä½ä½¿ç”¨è€…25ç§’ï¼ˆå…±30ç§’ï¼‰
        
        // é«˜å³°æœŸé–“ï¼šç¶­æŒå£“åŠ›60ç§’
        { duration: '60s', target: 40 },  // ç¶­æŒ40ä½ä½¿ç”¨è€…60ç§’
        
        // é™å£“æœŸé–“ï¼šæ¯5ç§’ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 30 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 20 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 10 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 0 },    // 5ç§’å…§ç§»é™¤å‰©é¤˜10ä½ä½¿ç”¨è€…
      ],
      gracefulRampDown: '5s',
      gracefulStop: '5s',
      tags: {
        test_type: 'stage_40_users',
        target: 'production',
        max_users: '40'
      }
    },
    
    // ç¬¬ä¸‰éšæ®µï¼š100 ç”¨æˆ¶æ¸¬è©¦ï¼ˆåœ¨ç¬¬äºŒéšæ®µå®Œæˆå¾Œé–‹å§‹ï¼‰
    // æ¯éš”30ç§’æ–°å¢10ä½ä½¿ç”¨è€…ï¼Œç›´åˆ°100ä½ä½¿ç”¨è€…
    stage_100_users: {
      executor: 'ramping-vus',
      startTime: '410s',  // ç¬¬äºŒéšæ®µå®Œæˆå¾Œé–‹å§‹
      stages: [
        // åŠ å£“æœŸé–“ï¼šæ¯éš”30ç§’æ–°å¢10ä½ä½¿ç”¨è€…ï¼ˆå…±éœ€9æ¬¡ï¼Œ270ç§’ï¼‰
        { duration: '5s', target: 10 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ10ä½ä½¿ç”¨è€…
        { duration: '25s', target: 10 },  // ç¶­æŒ10ä½ä½¿ç”¨è€…25ç§’
        { duration: '5s', target: 20 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ20ä½ä½¿ç”¨è€…
        { duration: '25s', target: 20 },  // ç¶­æŒ20ä½ä½¿ç”¨è€…25ç§’
        { duration: '5s', target: 30 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ30ä½ä½¿ç”¨è€…
        { duration: '25s', target: 30 },  // ç¶­æŒ30ä½ä½¿ç”¨è€…25ç§’
        { duration: '5s', target: 40 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ40ä½ä½¿ç”¨è€…
        { duration: '25s', target: 40 },  // ç¶­æŒ40ä½ä½¿ç”¨è€…25ç§’
        { duration: '5s', target: 50 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ50ä½ä½¿ç”¨è€…
        { duration: '25s', target: 50 },  // ç¶­æŒ50ä½ä½¿ç”¨è€…25ç§’
        { duration: '5s', target: 60 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ60ä½ä½¿ç”¨è€…
        { duration: '25s', target: 60 },  // ç¶­æŒ60ä½ä½¿ç”¨è€…25ç§’
        { duration: '5s', target: 70 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ70ä½ä½¿ç”¨è€…
        { duration: '25s', target: 70 },  // ç¶­æŒ70ä½ä½¿ç”¨è€…25ç§’
        { duration: '5s', target: 80 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ80ä½ä½¿ç”¨è€…
        { duration: '25s', target: 80 },  // ç¶­æŒ80ä½ä½¿ç”¨è€…25ç§’
        { duration: '5s', target: 90 },   // 5ç§’å…§å•Ÿå‹•å®Œæˆ90ä½ä½¿ç”¨è€…
        { duration: '25s', target: 90 },  // ç¶­æŒ90ä½ä½¿ç”¨è€…25ç§’
        { duration: '5s', target: 100 },  // 5ç§’å…§å•Ÿå‹•å®Œæˆ100ä½ä½¿ç”¨è€…
        { duration: '25s', target: 100 }, // ç¶­æŒ100ä½ä½¿ç”¨è€…25ç§’
        
        // é«˜å³°æœŸé–“ï¼šç¶­æŒå£“åŠ›60ç§’
        { duration: '60s', target: 100 }, // ç¶­æŒ100ä½ä½¿ç”¨è€…60ç§’
        
        // é™å£“æœŸé–“ï¼šæ¯5ç§’ç§»é™¤10ä½ä½¿ç”¨è€…ï¼ˆå…±éœ€10æ¬¡ï¼Œ50ç§’ï¼‰
        { duration: '5s', target: 90 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 80 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 70 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 60 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 50 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 40 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 30 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 20 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 10 },   // 5ç§’å…§ç§»é™¤10ä½ä½¿ç”¨è€…
        { duration: '5s', target: 0 },    // 5ç§’å…§ç§»é™¤å‰©é¤˜10ä½ä½¿ç”¨è€…
      ],
      gracefulRampDown: '5s',
      gracefulStop: '5s',
      tags: {
        test_type: 'stage_100_users',
        target: 'production',
        max_users: '100'
      }
    },
  },
  
  // é–¾å€¼è¨­å®š - æº«å’Œæ¸¬è©¦çš„åˆç†é–¾å€¼
  thresholds: {
    http_req_duration: ['p(95)<5000'],  // 95%çš„è«‹æ±‚æ‡‰åœ¨5ç§’å…§å®Œæˆ
    http_req_failed: ['rate<0.1'],      // å¤±æ•—ç‡æ‡‰ä½æ–¼10%
    http_reqs: ['rate>1'],              // æ¯ç§’è‡³å°‘1å€‹è«‹æ±‚
    'http_req_duration{expected_response:true}': ['p(95)<3000'], // æˆåŠŸè«‹æ±‚çš„95%éŸ¿æ‡‰æ™‚é–“
    moderate_load_errors: ['rate<0.15'], // è² è¼‰éŒ¯èª¤ç‡æ‡‰ä½æ–¼15%
    successful_requests: ['count>100'],  // æˆåŠŸè«‹æ±‚æ•¸æ‡‰è¶…é100
  },
  
  // ç³»çµ±è³‡æºé…ç½®
  noConnectionReuse: false,     // é‡ç”¨é€£æ¥ä»¥æå‡æ•ˆç‡
  userAgent: 'k6-moderate-load-test/1.0',
};

// æ¸¬è©¦å‡½æ•¸ - æº«å’Œå‹å£“åŠ›æ¸¬è©¦ï¼ˆ20/40/100 ç”¨æˆ¶ï¼‰
export default function() {
  const startTime = new Date().getTime();
  
  // ç²å–ç•¶å‰æ¸¬è©¦éšæ®µ
  const currentStage = __ENV.K6_STAGE || 'unknown';
  
  // æ¸¬è©¦æ­£å¼ä¸»æ©Ÿ
  let response = http.get('http://10.64.8.34/index.php', {
    timeout: '10s',  // 10ç§’è¶…æ™‚ï¼Œé©ç”¨æ–¼æº«å’Œè² è¼‰æ¸¬è©¦
    tags: { 
      test_type: 'moderate_load', 
      target: 'production',
      stage: currentStage
    }
  });
  
  const endTime = new Date().getTime();
  const responseTime = endTime - startTime;
  
  // è¨˜éŒ„è‡ªå®šç¾©æŒ‡æ¨™ - ä¾¿æ–¼ Grafana ç›£æ§
  moderateLoadRequests.add(1);
  moderateLoadResponseTime.add(responseTime);
  responseTimeP95.add(responseTime);
  responseTimeP99.add(responseTime);
  
  // è¨˜éŒ„è² è¼‰éšæ®µæŒ‡æ¨™
  if (__VU <= 20) {
    loadStageMetric.add(1, { stage: 'light_load_20' });
  } else if (__VU <= 40) {
    loadStageMetric.add(1, { stage: 'medium_load_40' });
  } else if (__VU <= 100) {
    loadStageMetric.add(1, { stage: 'heavy_load_100' });
  }
  
  // é©—è­‰å›æ‡‰ - æº«å’Œè² è¼‰æ¸¬è©¦çš„æª¢æŸ¥
  let success = check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 10s': (r) => r.timings.duration < 10000,  // 10ç§’å…§éŸ¿æ‡‰
    'response time < 5s': (r) => r.timings.duration < 5000,    // 5ç§’å…§éŸ¿æ‡‰ï¼ˆç†æƒ³ï¼‰
    'response time < 2s': (r) => r.timings.duration < 2000,    // 2ç§’å…§éŸ¿æ‡‰ï¼ˆè‰¯å¥½ï¼‰
    'response received': (r) => r.body && r.body.length > 0,   // æœ‰æ¥æ”¶åˆ°å…§å®¹
    'no server errors': (r) => r.status < 500,                // ç„¡æœå‹™å™¨éŒ¯èª¤
  });
  
  // éŒ¯èª¤åˆ†æå’Œè¨˜éŒ„ - ç‚º Grafana æä¾›è©³ç´°æ•¸æ“š
  if (!response || response.status !== 200) {
    moderateLoadErrors.add(1);
    failedRequests.add(1);
    
    // è¨˜éŒ„éŒ¯èª¤è©³æƒ…
    if (response && response.status >= 500) {
      console.log(`æœå‹™å™¨éŒ¯èª¤ - ç‹€æ…‹ç¢¼: ${response.status}, éŸ¿æ‡‰æ™‚é–“: ${responseTime}ms, VU: ${__VU}`);
    } else if (!response || responseTime >= 10000) {
      console.log(`è«‹æ±‚è¶…æ™‚ - éŸ¿æ‡‰æ™‚é–“: ${responseTime}ms, VU: ${__VU}`);
    } else if (response && response.status >= 400) {
      console.log(`å®¢æˆ¶ç«¯éŒ¯èª¤ - ç‹€æ…‹ç¢¼: ${response.status}, éŸ¿æ‡‰æ™‚é–“: ${responseTime}ms, VU: ${__VU}`);
    }
  } else {
    moderateLoadErrors.add(0);
    successfulRequests.add(1);
  }
  
  // è² è¼‰éšæ®µç‹€æ…‹è¨˜éŒ„
  if (__VU > 80) {
    // é«˜è² è¼‰éšæ®µçš„ç‰¹æ®Šè¨˜éŒ„
    if (responseTime > 5000) {
      console.log(`[é«˜è² è¼‰éšæ®µ] VU:${__VU}, éŸ¿æ‡‰æ™‚é–“:${responseTime}ms, ç‹€æ…‹:${response.status}`);
    }
  }
  
  // æ¨¡æ“¬ç”¨æˆ¶è¡Œç‚º - æº«å’Œè² è¼‰æ¸¬è©¦çš„æ€è€ƒæ™‚é–“
  sleep(Math.random() * 2 + 1);  // 1-3ç§’éš¨æ©Ÿæ€è€ƒæ™‚é–“
}

// è¨­ç½®éšæ®µ - æº«å’Œå‹å£“åŠ›æ¸¬è©¦ï¼ˆ20/40/100 ç”¨æˆ¶ï¼‰
export function setup() {
  console.log('ğŸš€ é–‹å§‹æº«å’Œå‹å£“åŠ›æ¸¬è©¦...');
  console.log('ğŸ¯ æ¸¬è©¦ç›®æ¨™ï¼šhttp://10.64.8.34/index.php');
  console.log('ğŸ“Š æ¸¬è©¦éšæ®µï¼š');
  console.log('   ç¬¬ä¸€éšæ®µï¼š20 ç”¨æˆ¶ (0-7åˆ†é˜)');
  console.log('   ç¬¬äºŒéšæ®µï¼š40 ç”¨æˆ¶ (8-16åˆ†é˜)');
  console.log('   ç¬¬ä¸‰éšæ®µï¼š100 ç”¨æˆ¶ (17-30åˆ†é˜)');
  console.log('â±ï¸ ç¸½æ¸¬è©¦æ™‚é–“ï¼šç´„ 30 åˆ†é˜');
  console.log('ğŸ“ˆ æº«å’Œè² è¼‰è¨­è¨ˆï¼Œé¿å…å°æœå‹™å™¨é€ æˆéå¤§å£“åŠ›');
  console.log('');
  console.log('ğŸ” æ¸¬è©¦éšæ®µè©³ç´°ï¼š');
  console.log('   éšæ®µ1 - è¼•è² è¼‰æ¸¬è©¦:');
  console.log('     â€¢ 1åˆ†é˜é ç†±åˆ°5ç”¨æˆ¶');
  console.log('     â€¢ 2åˆ†é˜å¢åŠ åˆ°20ç”¨æˆ¶');
  console.log('     â€¢ 3åˆ†é˜ç¶­æŒ20ç”¨æˆ¶');
  console.log('     â€¢ 1åˆ†é˜æ¸›å°‘åˆ°0ç”¨æˆ¶');
  console.log('   éšæ®µ2 - ä¸­è² è¼‰æ¸¬è©¦:');
  console.log('     â€¢ 1åˆ†é˜é ç†±åˆ°10ç”¨æˆ¶');
  console.log('     â€¢ 2åˆ†é˜å¢åŠ åˆ°40ç”¨æˆ¶');
  console.log('     â€¢ 4åˆ†é˜ç¶­æŒ40ç”¨æˆ¶');
  console.log('     â€¢ 1åˆ†é˜æ¸›å°‘åˆ°0ç”¨æˆ¶');
  console.log('   éšæ®µ3 - é‡è² è¼‰æ¸¬è©¦:');
  console.log('     â€¢ 1åˆ†é˜é ç†±åˆ°20ç”¨æˆ¶');
  console.log('     â€¢ 2åˆ†é˜å¢åŠ åˆ°50ç”¨æˆ¶');
  console.log('     â€¢ 2åˆ†é˜å¢åŠ åˆ°100ç”¨æˆ¶');
  console.log('     â€¢ 5åˆ†é˜ç¶­æŒ100ç”¨æˆ¶');
  console.log('     â€¢ 3åˆ†é˜é€æ­¥æ¸›å°‘åˆ°0ç”¨æˆ¶');
  console.log('');
  
  // æ¸¬è©¦ç›®æ¨™æœå‹™å™¨é€£é€šæ€§
  try {
    let testResponse = http.get('http://10.64.8.34/index.php', { timeout: '10s' });
    if (testResponse.status === 200) {
      console.log('âœ… ç›®æ¨™æœå‹™å™¨é€£é€šæ€§æ¸¬è©¦æˆåŠŸ');
      console.log(`   éŸ¿æ‡‰æ™‚é–“: ${testResponse.timings.duration}ms`);
      console.log(`   éŸ¿æ‡‰å¤§å°: ${testResponse.body.length} bytes`);
    } else {
      console.log(`âš ï¸ ç›®æ¨™æœå‹™å™¨è¿”å›ç‹€æ…‹ç¢¼: ${testResponse.status}`);
    }
  } catch (error) {
    console.log(`âŒ ç›®æ¨™æœå‹™å™¨é€£é€šæ€§æ¸¬è©¦å¤±æ•—: ${error}`);
  }
  
  console.log('');
  console.log('ğŸ¬ é–‹å§‹æ¸¬è©¦åŸ·è¡Œ...');
  
  return { 
    startTime: new Date().toISOString(),
    testType: 'moderate_load',
    maxUsers: 100
  };
}

// æ¸…ç†éšæ®µ
export function teardown(data) {
  console.log('');
  console.log('ğŸ æº«å’Œå‹å£“åŠ›æ¸¬è©¦å®Œæˆï¼');
  console.log(`æ¸¬è©¦é¡å‹: ${data.testType}`);
  console.log(`æœ€å¤§ç”¨æˆ¶æ•¸: ${data.maxUsers}`);
  console.log(`é–‹å§‹æ™‚é–“: ${data.startTime}`);
  console.log(`çµæŸæ™‚é–“: ${new Date().toISOString()}`);
  console.log('');
  console.log('ğŸ“Š æ•¸æ“šæ”¶é›†å®Œæˆï¼Œè«‹æª¢æŸ¥ï¼š');
  console.log('   - InfluxDB æ•¸æ“šåº«ä¸­çš„æ¸¬è©¦çµæœ');
  console.log('   - Grafana ç›£æ§å„€è¡¨æ¿');
  console.log('   - ä¸‰å€‹éšæ®µçš„æ€§èƒ½å°æ¯”');
  console.log('   - éŸ¿æ‡‰æ™‚é–“è¶¨å‹¢åˆ†æ');
  console.log('');
  console.log('ğŸ” å»ºè­°æŸ¥çœ‹çš„é—œéµæŒ‡æ¨™ï¼š');
  console.log('   - å„éšæ®µå¹³å‡éŸ¿æ‡‰æ™‚é–“');
  console.log('   - 95%éŸ¿æ‡‰æ™‚é–“åˆ†ä½ˆ');
  console.log('   - éŒ¯èª¤ç‡è®ŠåŒ–è¶¨å‹¢');
  console.log('   - ååé‡å°æ¯”');
}
